import {
  NewFeedback,
  Feedback,
  SuggestionFeedback,
  FeedbackGroupedByStatus,
} from "../types/feedback.types";
import { EditFeedbackFormValues } from "../types/form.types";
import { MutationResult } from "../types/mutation.types";
import { RoadmapFeedbackGroupedByStatus } from "../types/roadmap.types";
import { fetchWrapper, groupFeedbackByStatus } from "../utils/helpers";

export const API_URL: string = "http://localhost:9000"; //mock API generated by JSON server from data/data.json file

/* ---------------------------- */
/* Fetch feedback entries and groups them by status*/
export async function fetchAndGroupFeedback(
  // eslint-disable-next-line no-unused-vars
  pageContext: "feedbackBoard"
): Promise<FeedbackGroupedByStatus>;

export async function fetchAndGroupFeedback(
  // eslint-disable-next-line no-unused-vars
  pageContext: "developmentRoadmap"
): Promise<RoadmapFeedbackGroupedByStatus>;

export async function fetchAndGroupFeedback(
  pageContext: "feedbackBoard" | "developmentRoadmap"
): Promise<FeedbackGroupedByStatus | RoadmapFeedbackGroupedByStatus> {
  const queryCondition =
    pageContext === "feedbackBoard" ? "" : "?status_ne=suggestion";

  const feedbackList = await fetchWrapper<Feedback[]>(
    `${API_URL}/productRequests${queryCondition}`
  );

  const feedbackGroupedByStatus = groupFeedbackByStatus(feedbackList);

  if (pageContext === "developmentRoadmap") {
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    const { suggestion, ...rest } = feedbackGroupedByStatus;

    return rest;
  }

  return feedbackGroupedByStatus;
}

/* Fetch feedback by id */
export async function fetchFeedbackById(feedbackId: string): Promise<Feedback> {
  return fetchWrapper<Feedback>(`${API_URL}/productRequests/${feedbackId}`);
}

/* Submit new feedback */
export async function submitFeedback(
  feedback: NewFeedback
): Promise<MutationResult<SuggestionFeedback>> {
  try {
    const data = await fetchWrapper<SuggestionFeedback>(
      `${API_URL}/productRequests`,
      {
        method: "POST",
        body: JSON.stringify(feedback),
        headers: {
          "Content-Type": "application/json",
        },
      }
    );
    return { success: true, payload: data };
  } catch (err) {
    console.error("Something went wrong inside SubmitFeedback", err);
    return { success: false, error: err };
  }
}

/* Edit feedback entry */
export async function editFeedback(
  feedbackId: string,
  editedFeedback: EditFeedbackFormValues
): Promise<MutationResult<EditFeedbackFormValues>> {
  try {
    const data = await fetchWrapper<Feedback>(
      `${API_URL}/productRequests/${feedbackId}`,
      {
        method: "PATCH",
        body: JSON.stringify(editedFeedback),
        headers: {
          "Content-Type": "application/json",
        },
      }
    );

    const { title, category, status, description } = data;

    return { success: true, payload: { title, category, status, description } };
  } catch (err) {
    console.error("Something went wrong inside EditFeedback", err);
    return { success: false, error: err };
  }
}

/* Delete feedback entry */
export async function deleteFeedback(feedbackId: string): Promise<Feedback> {
  return fetchWrapper<Feedback>(`${API_URL}/productRequests/${feedbackId}`, {
    method: "DELETE",
  });
}

/* Update backend with current vote count after user's upvote/unvote actions */
export async function persistFeedbackVote(
  feedbackId: string,
  voteCount: number
): Promise<number> {
  try {
    const data = await fetchWrapper<Feedback>(
      `${API_URL}/productRequests/${feedbackId}`,
      {
        method: "PATCH",
        body: JSON.stringify({ upvotes: voteCount }),
        headers: {
          "Content-Type": "application/json",
        },
      }
    );

    return data.upvotes;
  } catch (err) {
    console.error("Something went wrong while upvoting feedback", err);
    throw err;
  }
}

/* Fetch user list */
export async function fetchUserList() {
  //return fetchWrapper(`${API_URL}/userList?username=${username}`);
}

/* Update commentCount when a new comment/reply is added - currently working only incrementing commentCount
   TO DO: use the same function to decrement commentCount when a comment/reply is deleted
*/
export async function updateCommentCount(
  feedbackId: string,
  updatedCommentCount: number
): Promise<number> {
  const data = await fetchWrapper<Feedback>(
    `${API_URL}/productRequests/${feedbackId}`,
    {
      method: "PATCH",
      body: JSON.stringify({ commentCount: updatedCommentCount }),
      headers: {
        "Content-Type": "application/json",
      },
    }
  );

  return data.upvotes;
}
